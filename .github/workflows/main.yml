name: Build
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build_lib:
    name: Build lib
    runs-on: windows-latest
    defaults:
      run:
        working-directory: lib

    steps:
    - name: Checkout PidginWinToastNotifications
      uses: actions/checkout@v2
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
 
    - name: Restore NuGet packages
      run: nuget restore PidginWinToastLib.sln
    
    - name: Build solution
      run: msbuild PidginWinToastLib.sln -property:Configuration=Release -property:Platform=x86
    
    - uses: actions/upload-artifact@v2
      name: Upload artifacts
      with:
        name: PidginWinToastLib
        path: |
          lib\Release\PidginWinToastLib.dll
          
  build_plugin:
    name: Build plugin
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
      
      # Checkout Plugin
      
      - name: Checkout PidginWinToastNotifications
        uses: actions/checkout@v2
        with:
          path: PidginWinToastNotifications


      # Prepare directories

      - name: Create win32-dev directory
        run: mkdir win32-dev
        shell: cmd
      
      - name: Create mingw directory
        run: mkdir win32-dev\mingw-4.7.2
        shell: cmd
      
      # Install Comnpiler dependencies
      
      - name: Download binutils
        # binutils-2.23.1-1-mingw32-bin.tar.lzma is not available anymore. Download the nearest version.
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/binutils/binutils-2.24/binutils-2.24-1-mingw32-bin.tar.xz/download --output binutils-2.24-1-mingw32-bin.tar.xz
        shell: cmd
      
      - name: Extract binutils
        # it looks like tar for Windows doesn't support xz, so use 7z instead
        run: 7z x binutils-2.24-1-mingw32-bin.tar.xz -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete binutils archive
        run: del binutils-2.24-1-mingw32-bin.tar.xz
        shell: cmd
        
        
      - name: Download gcc-core
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gcc/Version4/gcc-4.7.2-1/gcc-core-4.7.2-1-mingw32-bin.tar.lzma/download --output gcc-core-4.7.2-1-mingw32-bin.tar.lzma
        shell: cmd
      
      - name: Extract gcc-core
        run: 7z x gcc-core-4.7.2-1-mingw32-bin.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete gcc-core archive
        run: del gcc-core-4.7.2-1-mingw32-bin.tar.lzma
        shell: cmd    
      
        
      - name: Download gcc source
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gcc/Version4/gcc-4.7.2-1/gcc-4.7.2-1-mingw32-src.tar.lzma/download --output gcc-4.7.2-1-mingw32-src.tar.lzma
        shell: cmd
      
      - name: Extract gcc source
        run: 7z x gcc-4.7.2-1-mingw32-src.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete gcc source archive
        run: del gcc-4.7.2-1-mingw32-src.tar.lzma
        shell: cmd    
      
        
      - name: Download libgcc
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gcc/Version4/gcc-4.7.2-1/libgcc-4.7.2-1-mingw32-dll-1.tar.lzma/download --output libgcc-4.7.2-1-mingw32-dll-1.tar.lzma
        shell: cmd
      
      - name: Extract libgcc
        run: 7z x libgcc-4.7.2-1-mingw32-dll-1.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libgcc archive
        run: del libgcc-4.7.2-1-mingw32-dll-1.tar.lzma
        shell: cmd
        
        
      - name: Download libgomp
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gcc/Version4/gcc-4.7.2-1/libgomp-4.7.2-1-mingw32-dll-1.tar.lzma/download --output libgomp-4.7.2-1-mingw32-dll-1.tar.lzma
        shell: cmd
      
      - name: Extract libgomp
        run: 7z x libgomp-4.7.2-1-mingw32-dll-1.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libgomp archive
        run: del libgomp-4.7.2-1-mingw32-dll-1.tar.lzma
        shell: cmd
        
        
      - name: Download libquadmath
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gcc/Version4/gcc-4.7.2-1/libquadmath-4.7.2-1-mingw32-dll-0.tar.lzma/download --output libquadmath-4.7.2-1-mingw32-dll-0.tar.lzma
        shell: cmd
      
      - name: Extract libquadmath
        run: 7z x libquadmath-4.7.2-1-mingw32-dll-0.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libquadmath archive
        run: del libquadmath-4.7.2-1-mingw32-dll-0.tar.lzma
        shell: cmd
        
        
      - name: Download libssp
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gcc/Version4/gcc-4.7.2-1/libssp-4.7.2-1-mingw32-dll-0.tar.lzma/download --output libssp-4.7.2-1-mingw32-dll-0.tar.lzma
        shell: cmd
      
      - name: Extract libssp
        run: 7z x libssp-4.7.2-1-mingw32-dll-0.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libssp archive
        run: del libssp-4.7.2-1-mingw32-dll-0.tar.lzma
        shell: cmd
      
        
      - name: Download gettext
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gettext/gettext-0.18.1.1-2/libintl-0.18.1.1-2-mingw32-dll-8.tar.lzma/download --output libintl-0.18.1.1-2-mingw32-dll-8.tar.lzma
        shell: cmd
      
      - name: Extract gettext
        run: 7z x libintl-0.18.1.1-2-mingw32-dll-8.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete gettext archive
        run: del libintl-0.18.1.1-2-mingw32-dll-8.tar.lzma
        shell: cmd
        
        
      - name: Download gmp
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gmp/gmp-5.0.1-1/gmp-5.0.1-1-mingw32-dev.tar.lzma/download --output gmp-5.0.1-1-mingw32-dev.tar.lzma
        shell: cmd
      
      - name: Extract gmp
        run: 7z x gmp-5.0.1-1-mingw32-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete gmp archive
        run: del gmp-5.0.1-1-mingw32-dev.tar.lzma
        shell: cmd
        
        
      - name: Download libgmp
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/gmp/gmp-5.0.1-1/libgmp-5.0.1-1-mingw32-dll-10.tar.lzma/download --output glibgmp-5.0.1-1-mingw32-dll-10.tar.lzma
        shell: cmd
      
      - name: Extract libgmp
        run: 7z x glibgmp-5.0.1-1-mingw32-dll-10.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libgmp archive
        run: del glibgmp-5.0.1-1-mingw32-dll-10.tar.lzma
        shell: cmd
        
        
      - name: Download libiconv dev
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/libiconv/libiconv-1.14-2/libiconv-1.14-2-mingw32-dev.tar.lzma/download --output libiconv-1.14-2-mingw32-dev.tar.lzma
        shell: cmd
      
      - name: Extract libiconv dev
        run: 7z x libiconv-1.14-2-mingw32-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libiconv dev archive
        run: del libiconv-1.14-2-mingw32-dev.tar.lzma
        shell: cmd
        
        
      - name: Download libiconv dll
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/libiconv/libiconv-1.14-2/libiconv-1.14-2-mingw32-dll-2.tar.lzma/download --output libiconv-1.14-2-mingw32-dll-2.tar.lzma
        shell: cmd
      
      - name: Extract libiconv dll
        run: 7z x libiconv-1.14-2-mingw32-dll-2.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libiconv dll archive
        run: del libiconv-1.14-2-mingw32-dll-2.tar.lzma
        shell: cmd
        
        
      - name: Download mingwrt dev
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/mingwrt/mingwrt-3.20/mingwrt-3.20-2-mingw32-dev.tar.lzma/download --output mingwrt-3.20-2-mingw32-dev.tar.lzma
        shell: cmd
      
      - name: Extract mingwrt dev
        run: 7z x mingwrt-3.20-2-mingw32-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete mingwrt dev archive
        run: del mingwrt-3.20-2-mingw32-dev.tar.lzma
        shell: cmd
        
        
      - name: Download mingwrt dll
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/mingwrt/mingwrt-3.20/mingwrt-3.20-2-mingw32-dll.tar.lzma/download --output mingwrt-3.20-2-mingw32-dll.tar.lzma
        shell: cmd
      
      - name: Extract mingwrt dll
        run: 7z x mingwrt-3.20-2-mingw32-dll.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete mingwrt dll archive
        run: del mingwrt-3.20-2-mingw32-dll.tar.lzma
        shell: cmd
        
        
      - name: Download mpc dll
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/mpc/mpc-0.8.1-1/libmpc-0.8.1-1-mingw32-dll-2.tar.lzma/download --output libmpc-0.8.1-1-mingw32-dll-2.tar.lzma
        shell: cmd
      
      - name: Extract mpc dll
        run: 7z x libmpc-0.8.1-1-mingw32-dll-2.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete mpc dll archive
        run: del libmpc-0.8.1-1-mingw32-dll-2.tar.lzma
        shell: cmd
        
        
      - name: Download mpc dev
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/mpc/mpc-0.8.1-1/mpc-0.8.1-1-mingw32-dev.tar.lzma/download --output mpc-0.8.1-1-mingw32-dev.tar.lzma
        shell: cmd
      
      - name: Extract mpc dev
        run: 7z x mpc-0.8.1-1-mingw32-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete mpc dev archive
        run: del mpc-0.8.1-1-mingw32-dev.tar.lzma
        shell: cmd
        
        
      - name: Download mpfr dll
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/mpfr/mpfr-2.4.1-1/libmpfr-2.4.1-1-mingw32-dll-1.tar.lzma/download --output libmpfr-2.4.1-1-mingw32-dll-1.tar.lzma
        shell: cmd
      
      - name: Extract mpfr dll
        run: 7z x libmpfr-2.4.1-1-mingw32-dll-1.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete mpfr dll archive
        run: del libmpfr-2.4.1-1-mingw32-dll-1.tar.lzma
        shell: cmd
        
        
      - name: Download mpfr dev
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/mpfr/mpfr-2.4.1-1/mpfr-2.4.1-1-mingw32-dev.tar.lzma/download --output mpfr-2.4.1-1-mingw32-dev.tar.lzma
        shell: cmd
      
      - name: Extract mpfr dev
        run: 7z x mpfr-2.4.1-1-mingw32-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete mpfr dev archive
        run: del mpfr-2.4.1-1-mingw32-dev.tar.lzma
        shell: cmd
        
        
      - name: Download w32api
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/w32api/w32api-3.17/w32api-3.17-2-mingw32-dev.tar.lzma/download --output w32api-3.17-2-mingw32-dev.tar.lzma
        shell: cmd
      
      - name: Extract w32api
        run: 7z x w32api-3.17-2-mingw32-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete w32api archive
        run: del w32api-3.17-2-mingw32-dev.tar.lzma
        shell: cmd
        
        
      - name: Download libpthreadgc dll
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/pthreads-w32/pthreads-w32-2.9.0-pre-20110507-2/libpthreadgc-2.9.0-mingw32-pre-20110507-2-dll-2.tar.lzma/download --output libpthreadgc-2.9.0-mingw32-pre-20110507-2-dll-2.tar.lzma
        shell: cmd
      
      - name: Extract libpthreadgc dll
        run: 7z x libpthreadgc-2.9.0-mingw32-pre-20110507-2-dll-2.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete libpthreadgc dll archive
        run: del libpthreadgc-2.9.0-mingw32-pre-20110507-2-dll-2.tar.lzma
        shell: cmd
        
        
      - name: Download pthreads dev
        run: curl -L https://sourceforge.net/projects/mingw/files/MinGW/Base/pthreads-w32/pthreads-w32-2.9.0-pre-20110507-2/pthreads-w32-2.9.0-mingw32-pre-20110507-2-dev.tar.lzma/download --output pthreads-w32-2.9.0-mingw32-pre-20110507-2-dev.tar.lzma
        shell: cmd
      
      - name: Extract pthreads dev
        run: 7z x pthreads-w32-2.9.0-mingw32-pre-20110507-2-dev.tar.lzma -so | 7z x -aoa -si -ttar -owin32-dev\mingw-4.7.2
        shell: cmd
        
      - name: Delete pthreads dev archive
        run: del pthreads-w32-2.9.0-mingw32-pre-20110507-2-dev.tar.lzma
        shell: cmd
        
      
      - name: List win32-dev/mingw-4.7.2 dir
        run: dir win32-dev\mingw-4.7.2
        shell: cmd        
      
      # Installing Build dependencies
      
      - name: Download GTK archive
        run: curl -L https://ftp.gnome.org/pub/gnome/binaries/win32/gtk+/2.14/gtk+-bundle_2.14.7-20090119_win32.zip --output gtk.zip
        shell: cmd
      
      - name: Extract GTK 
        run: 7z x gtk.zip -owin32-dev/gtk_2_0-2.14
        shell: cmd
      
      - name: Delete GTK archive
        run: del gtk.zip
        shell: cmd
      
      
      - name: Download gettext tools archive
        run: curl -L https://ftp.gnome.org/pub/gnome/binaries/win32/dependencies/gettext-tools-0.17.zip --output gettext-tools-0.17.zip
        shell: cmd
      
      - name: Extract gettext tools
        run: 7z x gettext-tools-0.17.zip -owin32-dev/gettext-0.17
        shell: cmd
      
      - name: Delete gettext tools archive
        run: del gettext-tools-0.17.zip
        shell: cmd
      
      
      - name: Download gettext runtime
        run: curl -L https://ftp.gnome.org/pub/gnome/binaries/win32/dependencies/gettext-runtime-0.17-1.zip --output gettext-runtime-0.17-1.zip
        shell: cmd
      
      - name: Extract gettext runtime
        run: 7z x gettext-runtime-0.17-1.zip -owin32-dev/gettext-0.17
        shell: cmd
      
      - name: Delete gettext tools runtime archive
        run: del gettext-runtime-0.17-1.zip
        shell: cmd        
            
      
      - name: Download GtkSpell
        run: curl -L https://data.imfreedom.org/pidgin/win32/gtkspell-2.0.16.tar.bz2 --output gtkspell-2.0.16.tar.bz2
        shell: cmd
      
      - name: Extract GtkSpell
        run: tar -xf gtkspell-2.0.16.tar.bz2 -C win32-dev
        shell: cmd
      
      - name: Delete GtkSpell archive
        run: del gtkspell-2.0.16.tar.bz2
        shell: cmd    
            
      
      - name: Download Enchant
        run: curl -L https://data.imfreedom.org/pidgin/win32/enchant_1.6.0_win32.zip --output enchant_1.6.0_win32.zip
        shell: cmd
      
      - name: Extract Enchant
        run: 7z x enchant_1.6.0_win32.zip -owin32-dev
        shell: cmd
      
      - name: Delete Enchant archive
        run: del enchant_1.6.0_win32.zip
        shell: cmd  
            
      
      - name: Download Mozilla NSS
        run: curl -L https://data.imfreedom.org/pidgin/win32/nss-3.24-nspr-4.12.tar.gz --output nss-3.24-nspr-4.12.tar.gz
        shell: cmd
      
      - name: Extract Mozilla NSS
        run: tar -xf nss-3.24-nspr-4.12.tar.gz -C win32-dev
        shell: cmd
      
      - name: Delete Mozilla NSS archive
        run: del nss-3.24-nspr-4.12.tar.gz
        shell: cmd  
      
      
      - name: Download SILC Toolkit
        run: curl -L https://data.imfreedom.org/pidgin/win32/silc-toolkit-1.1.12.tar.gz --output silc-toolkit-1.1.12.tar.gz
        shell: cmd
      
      - name: Extract SILC Toolkit
        run: tar -xf silc-toolkit-1.1.12.tar.gz -C win32-dev
        shell: cmd
      
      - name: Delete SILC Toolkit archive
        run: del silc-toolkit-1.1.12.tar.gz
        shell: cmd                       
       
      
      - name: Download Meanwhile
        run: curl -L https://data.imfreedom.org/pidgin/win32/meanwhile-1.0.2_daa3-win32.zip --output meanwhile-1.0.2_daa3-win32.zip
        shell: cmd
      
      - name: Extract Meanwhile
        run: 7z x meanwhile-1.0.2_daa3-win32.zip -owin32-dev
        shell: cmd
      
      - name: Delete Meanwhile archive
        run: del meanwhile-1.0.2_daa3-win32.zip
        shell: cmd  
       
      
      - name: Download Cyrus SASL
        run: curl -L https://data.imfreedom.org/pidgin/win32/cyrus-sasl-2.1.26_daa1.tar.gz --output cyrus-sasl-2.1.26_daa1.tar.gz
        shell: cmd
      
      - name: Extract Cyrus SASL
        run: tar -xf cyrus-sasl-2.1.26_daa1.tar.gz -C win32-dev
        shell: cmd
      
      - name: Delete Cyrus SASL archive
        run: del cyrus-sasl-2.1.26_daa1.tar.gz
        shell: cmd  
       
      
      - name: Download Intltool
        run: curl -L https://ftp.acc.umu.se/pub/GNOME/binaries/win32/intltool/0.40/intltool_0.40.4-1_win32.zip --output intltool_0.40.4-1_win32.zip
        shell: cmd
      
      - name: Extract Intltool
        run: 7z x intltool_0.40.4-1_win32.zip -owin32-dev/intltool_0.40.4-1_win32
        shell: cmd
      
      - name: Delete Intltool archive
        run: del intltool_0.40.4-1_win32.zip
        shell: cmd  
       
      
      - name: Download Crash Reporting Library
        run: curl -L https://data.imfreedom.org/pidgin/win32/pidgin-inst-deps-20130214.tar.gz --output pidgin-inst-deps-20130214.tar.gz
        shell: cmd
      
      - name: Extract Crash Reporting Library
        run: tar -xf pidgin-inst-deps-20130214.tar.gz -C win32-dev
        shell: cmd
      
      - name: Delete Crash Reporting Library archive
        run: del pidgin-inst-deps-20130214.tar.gz
        shell: cmd
      
      
      # Setup MSYS2
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW32
          install: bash bzip2 ca-certificates coreutils gawk gnupg grep gzip libiconv make patch sed tar unzip wget zip
      
      
      # Get Pidgin source code
      
      - name: Checkout Pidgin 2.12.0
        run: hg clone https://keep.imfreedom.org/pidgin/pidgin -r 0241f07ed2ba -b release-2.x.y -u v2.12.0 pidgin-2.x.y
        shell: cmd
      
      
      # Prepare a libssp-src.tar.gz file containing the libssp sources and licenses
      
      - name: Preparing libssp-src.tar.gz
        run: mkdir libsspsrctmp
          tar -C libsspsrctmp -xf gcc-4.7.2-1-mingw32-src/gcc-4.7.2.tar.bz2 gcc-4.7.2/COPYING3 gcc-4.7.2/COPYING.RUNTIME gcc-4.7.2/libssp --strip-components=1
          tar -C libsspsrctmp -czf bin/libssp-src.tar.gz .
          rm -r libsspsrctmp
        shell: cmd
        working-directory: "./win32-dev/mingw-4.7.2"
      
      
      # TODO: set the MinGW gcc’s bin directory to be before Cygwin’s in bashrc
      
      - name: Current Path
        run: dir "C:\cygwin\home\"
        shell: cmd
            
    
      # List dirs for debug
      
      - name: List pidgin-dev dir
        run: dir
        shell: cmd
      
      - name: List pidgin-dev/win32-dev dir
        run: dir win32-dev
        shell: cmd
        
      - name: List pidgin-dev/win32-dev/mingw-4.7.2 dir
        run: dir "win32-dev/mingw-4.7.2"
        shell: cmd
      
      - name: List pidgin-dev/pidgin-2.x.y dir
        run: dir pidgin-2.x.y
        shell: cmd       
        
      # Build Pidgin
        
      - name: Build Pidgin
        run: make -f Makefile.mingw install
        working-directory: ./pidgin-2.x.y
